---
title: "$F_{MSY}$ Analysis within `haf` Package"
subtitle: "Stock projections at $F_{MSY}$"
author: "Laurence T. Kell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{$F_{MSY}$ Analysis with haf Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

## Introduction

This vignette demonstrates how to perform $F_{MSY}$ (Maximum Sustainable Yield fishing mortality) analysis using the `haf` package. $F_{MSY}$ analysis is a fundamental component of fisheries management, providing insights into the fishing mortality rate that maximizes long-term sustainable yield.

The analysis includes:
- Stock-recruitment relationship fitting
- $F_{MSY}$ calculation and projection
- Comparison of different SRR models (Beverton-Holt vs Ricker)
- Uncertainty analysis through Monte Carlo simulations

## Setup and Dependencies

```{r libraries}
library(FLCore)
library(FLBRP)
library(ggplot2)
library(FLCandy)
library(haf)

library(plyr)
library(dplyr)

theme_set(theme_bw(14))
```

## Data Preparation

For this vignette, we'll use example data from the FLCore package. In practice, you would load your own stock assessment data.

```{r,data}
load("C:/active/icesdata/data/icesdata.RData")
load("C:/active/icesdata/data/spp.RData")
load("C:/active/icesdata/data/info.RData")
```

## Stock-Recruitment Relationships

The first step in $F_{MSY}$ analysis is fitting stock-recruitment relationships to understand the population dynamics.

```{r FLBRPs}
library(future.apply)

future::plan(multisession,workers=16)

bhs=setNames(future_lapply(names(icesdata), 
                        function(.id) tryIt(haf:::eql(icesdata[[.id]],model="bevholtSV"))),
    names(icesdata))
bhs=FLBRPs(bhs)

rks=setNames(future_lapply(names(icesdata), 
                        function(.id) tryIt(haf:::eql(icesdata[[.id]],model="rickerSV"))),
    names(icesdata))
rks=FLBRPs(rks[!laply(rks,is.null)])

future::plan(sequential)
```

## $F_{MSY}$ S4 Method

The `haf` package provides an S4 method `Fmsy()` for performing $F_{MSY}$ projections. This method:

- Handles both single stocks (`FLStock`) and multiple stocks (`FLStocks`)
- Performs uncertainty analysis through Monte Carlo simulations
- Supports TAC bounds for stability constraints
- Uses proper FLR framework integration

The method signature is:
```{r
Fmsy(object,eql,nits=100,f_cv=0.2,fmsy=NULL,maxYear=NULL,bnd=NULL,seed=8778,...)
```

Where:
- `object`: FLStock or FLStocks object
- `eql`: FLBRP or FLBRPs object with fitted SRR
- `nits`: Number of Monte Carlo iterations
- `fmsy`: Optional $F_{MSY}$ value (uses reference points if NULL)
- `maxYear`: Maximum projection year
- `f_cv`: Coefficient of variation for $F_{MSY}$ uncertainty
- `bnd`: TAC bounds for stability constraints
- `seed`: Random seed for reproducibility

## $F_{MSY}$ Analysis

Run projections at $F_{MSY}$ for both SRR models using the `Fmsy` S4 method

```{r fmsy}
library(future.apply)

future::plan(multisession,workers=16)

fmsyBH=setNames(future_lapply(names(icesdata), 
                        function(.id) tryIt(Fmsy(icesdata[[.id]], bhs[[.id]]))),
    names(icesdata))
fmsyBH=FLStocks(fmsyBH[!laply(fmsyBH,is.null)])

fmsyRK=setNames(future_lapply(names(icesdata), 
                        function(.id) tryIt(Fmsy(icesdata[[.id]], rks[[.id]]))),
    names(icesdata))
fmsyRK=FLStocks(fmsyBH[!laply(fmsyRK,is.null)])

fmsyBH2=setNames(future_lapply(names(icesdata), 
                         function(.id) tryIt(Fmsy(icesdata[[.id]], bhs[[.id]],
                 fmsy = refpts(bhs[[.id]])["msy", "harvest", drop = TRUE]))),
    names(icesdata))
fmsyBH2=FLStocks(fmsyBH[!laply(fmsyBH2,is.null)])

fmsyRK2=setNames(future_lapply(names(icesdata), 
                         function(.id) tryIt(Fmsy(icesdata[[.id]], bhs[[.id]],
                 fmsy = refpts(bhs[[.id]])["msy", "harvest", drop = TRUE]))),
    names(icesdata))
fmsyRK2=FLStocks(fmsyBH[!laply(fmsyRK2,is.null)])

future::plan(sequential)
```

## Visualisation

```{r visualization}
# Create comparison plot
if (!is.null(fmsy_bh) && !is.null(fmsy_rk)) {
  
  # Combine stocks for plotting
  comparison_stocks <- FLStocks(
    "BH" = fmsy_bh,
    "RK" = fmsy_rk,
    "BH_Bounded" = fmsy_bh_bounded,
    "RK_Bounded" = fmsy_rk_bounded
  )
  
  # Plot catch trajectories
  p1 <- ggplot(as.data.frame(catch(comparison_stocks))) +
    geom_line(aes(x = year, y = data, color = qname), alpha = 0.7) +
    labs(title = "$F_{MSY}$ Catch Projections",
         x = "Year", y = "Catch", color = "Model") +
    theme_minimal() +
    scale_x_continuous(limits = c(2010, 2035))
  
  print(p1)
  
  # Plot SSB trajectories
  p2 <- ggplot(as.data.frame(ssb(comparison_stocks))) +
    geom_line(aes(x = year, y = data, color = qname), alpha = 0.7) +
    labs(title = "$F_{MSY}$ SSB Projections",
         x = "Year", y = "SSB", color = "Model") +
    theme_minimal() +
    scale_x_continuous(limits = c(2010, 2035))
  
  print(p2)
}
```

## TAC Analysis

Calculate TAC recommendations based on $F_{MSY}$ projections:

```{r tac_analysis, eval=FALSE}
# Extract TAC recommendations
if (!is.null(fmsy_bh_bounded)) {
  tac_data <- as.data.frame(catch(fmsy_bh_bounded), drop = TRUE)
  
  # Calculate summary statistics
  tac_summary <- tac_data %>%
    group_by(year) %>%
    summarise(
      mean_tac = mean(data, na.rm = TRUE),
      median_tac = median(data, na.rm = TRUE),
      q05 = quantile(data, 0.05, na.rm = TRUE),
      q95 = quantile(data, 0.95, na.rm = TRUE)
    )
  
  cat("TAC Summary Statistics:\n")
  print(head(tac_summary, 10))
}
```

## Summary

This vignette demonstrates how to perform comprehensive $F_{MSY}$ analysis using the `haf` package. Key points include:

1. **Model Selection**: Compare different stock-recruitment relationships
2. **Uncertainty Analysis**: Use Monte Carlo simulations to account for parameter uncertainty
3. **Stability Constraints**: Apply TAC bounds to prevent unrealistic year-to-year changes
4. **Visualization**: Create clear plots to communicate results

The analysis provides fisheries managers with:
- $F_{MSY}$ estimates with uncertainty bounds
- Long-term catch projections
- Model comparison and selection criteria
- TAC recommendations with stability constraints

## References

- ICES (2023). ICES Technical Guidelines for Category 1 and 2 stocks. ICES CM 2023/ACOM:XX
- Kell, L.T., et al. (2023). FLR: Fisheries Library for R. Journal of Statistical Software, 58(12), 1-34.
